var e=Object.defineProperty,l=Object.defineProperties,a=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,t=Object.prototype.propertyIsEnumerable,o=(l,a,r)=>a in l?e(l,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):l[a]=r,d=(e,l)=>{for(var a in l||(l={}))s.call(l,a)&&o(e,a,l[a]);if(r)for(var a of r(l))t.call(l,a)&&o(e,a,l[a]);return e},n=(e,r)=>l(e,a(r)),i=(e,l)=>{var a={};for(var o in e)s.call(e,o)&&l.indexOf(o)<0&&(a[o]=e[o]);if(null!=e&&r)for(var o of r(e))l.indexOf(o)<0&&t.call(e,o)&&(a[o]=e[o]);return a},u=(e,l,a)=>new Promise((r,s)=>{var t=e=>{try{d(a.next(e))}catch(l){s(l)}},o=e=>{try{d(a.throw(e))}catch(l){s(l)}},d=e=>e.done?r(e.value):Promise.resolve(e.value).then(t,o);d((a=a.apply(e,l)).next())});import{dS as m,dT as p,d$ as c,d as f,a as y,c as _,r as g,w as v,o as h,y as b,f as k,z as I,p as V,u as j,e as w,G as x,H as q,h as O,m as P,l as E,I as U,N as D,n as A}from"./index-80d0f50K.js";import{E as S}from"./el-dialog-1gzNkj9H.js";import"./el-overlay-GydQvYeA.js";import{E as z}from"./el-button-fxR6_Zjf.js";import{E as H,a as R}from"./el-form-item-fw-CxUqd.js";/* empty css               */import{E as T,a as $}from"./el-option-1zm3uFw0.js";/* empty css                  *//* empty css                     *//* empty css                  *//* empty css                *//* empty css                    *//* empty css                *//* empty css                       */import{E as G}from"./el-row-CWq4c_Ai.js";import{E as M}from"./el-col-DtVXklDZ.js";/* empty css                 */import{g as B}from"./role-BdOkOxvc.js";import{g as C}from"./dept-KG10lbx8.js";import{g as N}from"./post-CJEsuL6w.js";import{E as J}from"./index-HP-ZmGVO.js";import{E as L}from"./index-Bw7fD_Sj.js";function Q(e){return u(this,null,function*(){const{page:l=1,pageSize:a=10,username:r,status:s,deptId:t}=e;let o=m.from("sys_user").select("\n    *,\n    sys_dept(dept_name),\n    sys_post(post_name),\n    sys_user_role(sys_role(role_name))\n  ");r&&(o=o.ilike("username",`%${r}%`)),void 0!==s&&(o=o.eq("status",1===s)),t&&(o=o.eq("dept_id",t));const{data:i,error:u,count:c}=yield o.order("create_time",{ascending:!1}).range((l-1)*a,l*a-1);u&&p(u.code,"获取用户列表失败");return{list:null==i?void 0:i.map(e=>{const l=e.sys_user_role.map(e=>{var l;return null==(l=e.sys_role)?void 0:l.role_name}).filter(Boolean).join(",");return n(d({},e),{role_names:l,status:e.status?1:0,sys_user_role:void 0})}),total:c||0,page:l,pageSize:a}})}function Z(e){return u(this,null,function*(){e||p("0","用户ID不能为空");const{data:l,error:a}=yield m.from("sys_user").select("id").eq("id",e).single();!a&&l||p(a.code,"用户不存在");const{error:r}=yield m.from("sys_user_role").delete().eq("user_id",e);r&&p(r.code,"删除用户角色关联失败");const{error:s}=yield m.from("sys_user").delete().eq("id",e);return s&&p(s.code,"删除用户失败"),{message:"删除用户成功"}})}function F(e){return u(this,null,function*(){e&&Array.isArray(e)&&0!==e.length||p("0","请选择要删除的用户");const{error:l}=yield m.from("sys_user_role").delete().in("user_id",e);l&&p(l.code,"删除用户角色关联失败");const{error:a}=yield m.from("sys_user").delete().in("id",e);return a&&p(a.code,"批量删除用户失败"),{message:"批量删除用户成功"}})}const K={style:{float:"left"}},W={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},X={class:"dialog-footer"},Y=f({__name:"user-dialog",props:{visible:{type:Boolean},type:{},userData:{}},emits:["update:visible","submit"],setup(e,{emit:l}){const a=e,r=l,s=y([]),t=y([]),o=y([]),f=_({get:()=>a.visible,set:e=>r("update:visible",e)}),Q=_(()=>a.type),Z=y(),F=y(!1),Y=g({username:"",nickname:"",email:"",phone:"",deptId:void 0,postId:void 0,gender:0,status:1,remark:"",roleIds:[]}),ee={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],nickname:[{max:50,message:"长度不能超过 50 个字符",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号格式",trigger:"blur"}]};function le(){const e=[],l=a=>{a.forEach(a=>{e.push(a.id),a.children&&a.children.length>0&&l(a.children)})};return l(t.value),e}const ae=()=>u(null,null,function*(){var e;const l="edit"===a.type&&a.userData,r=a.userData;if(Object.assign(Y,{username:l&&r&&r.username||"",nickname:l&&r&&r.nickname||"",email:l&&r&&r.email||"",phone:l&&r&&r.phone||"",deptId:l&&r?r.dept_id:void 0,postId:l&&r?r.post_id:void 0,gender:l&&r?r.gender:0,status:l&&r?r.status:1,remark:l&&r&&r.remark||"",roleIds:[],confirmPassword:""}),l&&(null==r?void 0:r.id))try{const l=yield function(e){return u(this,null,function*(){e||p("0","用户ID不能为空");const{data:l,error:a}=yield m.from("sys_user").select("\n      *,\n      sys_dept(dept_name),\n      sys_post(post_name)\n    ").eq("id",e).single();!a&&l||p(null==a?void 0:a.code,"用户不存在");const{data:r,error:s}=yield m.from("sys_user_role").select("\n      sys_role(*)\n    ").eq("user_id",e);s&&p(s.code,"获取用户角色失败");const t=null==r?void 0:r.map(e=>e.sys_role);return n(d({},l),{status:l.status?1:0,roles:t})})}(r.id);Y.roleIds=(null==(e=null==l?void 0:l.roles)?void 0:e.map(e=>e.id))||[]}catch(s){}});v(()=>[a.visible,a.type,a.userData],([e])=>{e&&(ae(),A(()=>{var e;null==(e=Z.value)||e.clearValidate()}))},{immediate:!0});const re=()=>u(null,null,function*(){Z.value&&(yield Z.value.validate(e=>u(null,null,function*(){var l;if(e){F.value=!0;try{if("add"===Q.value){const e=Y,{confirmPassword:l}=e,a=i(e,["confirmPassword"]);yield function(e){return u(this,null,function*(){const{username:l,password:a,nickname:r,avatar:s,email:t,phone:o,deptId:d,postId:n,gender:i,status:u,remark:f,roleIds:y}=e,{data:_,error:g}=yield m.from("sys_user").select("id").eq("username",l).single();("PGRST116"!==(null==g?void 0:g.code)||_)&&p(null==g?void 0:g.code,"用户名已存在");const v=yield c.hash(a||"superman,123",10),{data:h,error:b}=yield m.from("sys_user").insert({username:l,password:v,nickname:r,avatar:s,email:t,phone:o,dept_id:d,post_id:n,gender:i||0,status:void 0===u||u,remark:f}).select("id").single();if(!b&&h||p(b.code,"创建用户失败"),y&&y.length>0){const e=y.map(e=>({user_id:null==h?void 0:h.id,role_id:e})),{error:l}=yield m.from("sys_user_role").insert(e);l&&p(l.code,"关联用户角色失败")}return{message:"创建用户成功"}})}({username:a.username,nickname:a.nickname,avatar:a.avatar,email:a.email,phone:a.phone,deptId:a.deptId,postId:a.postId,gender:a.gender,status:1===a.status,remark:a.remark,roleIds:a.roleIds}),D.success("添加成功")}else{const e=i(Y,[]);yield function(e,l){return u(this,null,function*(){e||p("0","用户ID不能为空");const{username:a,password:r,nickname:s,avatar:t,email:o,phone:d,deptId:n,postId:i,gender:u,status:f,remark:y,roleIds:_}=l,{data:g,error:v}=yield m.from("sys_user").select("id, username").eq("id",e).single();if(!v&&g||p(v.code,"用户不存在"),a&&a!==(null==g?void 0:g.username)){const{data:l,error:r}=yield m.from("sys_user").select("id").eq("username",a).neq("id",e).single();("PGRST116"!==(null==r?void 0:r.code)||l)&&p(null==r?void 0:r.code,"用户名已存在")}const h={username:a||(null==g?void 0:g.username),nickname:s,avatar:t,email:o,phone:d,dept_id:n,post_id:i,gender:void 0!==u?u:0,status:void 0!==f?f:0,remark:y};r&&(h.password=yield c.hash(r,10));const{error:b}=yield m.from("sys_user").update(h).eq("id",e);if(b&&p(b.code,"更新用户失败"),void 0!==_){const{error:l}=yield m.from("sys_user_role").delete().eq("user_id",e);if(l&&p(l.code,"删除用户角色关联失败"),_.length>0){const l=_.map(l=>({user_id:e,role_id:l})),{error:a}=yield m.from("sys_user_role").insert(l);a&&p(a.code,"添加用户角色关联失败")}}return{message:"更新用户成功"}})}(null==(l=a.userData)?void 0:l.id,{username:e.username,nickname:e.nickname,avatar:e.avatar,email:e.email,phone:e.phone,deptId:e.deptId,postId:e.postId,gender:e.gender,status:1===e.status,remark:e.remark,roleIds:e.roleIds}),D.success("更新成功")}f.value=!1,r("submit")}catch(s){D.error(s.message||"操作失败")}finally{F.value=!1}}})))});return h(()=>{!function(){u(this,null,function*(){try{const e=yield B();s.value=Array.isArray(e.list)?e.list:[]}catch(e){}})}(),function(){u(this,null,function*(){try{const e=yield C();if(Array.isArray(e)){const l=new Map,a=[];e.forEach(e=>{l.set(e.id,n(d({},e),{children:[]}))}),e.forEach(e=>{const r=l.get(e.id);if("0"!==e.parent_id&&e.parent_id){const a=l.get(e.parent_id);a&&a.children.push(r)}else a.push(r)}),t.value=a}}catch(e){}})}(),function(){u(this,null,function*(){try{const e=yield N();o.value=Array.isArray(e.list)?e.list:[]}catch(e){}})}()}),(e,l)=>{const a=J,r=R,d=M,n=G,i=$,u=T,m=L,p=H,c=z,y=S;return k(),b(y,{modelValue:j(f),"onUpdate:modelValue":l[11]||(l[11]=e=>U(f)?f.value=e:null),title:"add"===j(Q)?"添加用户":"编辑用户",width:"600px","align-center":"","close-on-click-modal":!1},{footer:I(()=>[O("div",X,[V(c,{onClick:l[10]||(l[10]=e=>f.value=!1)},{default:I(()=>[...l[12]||(l[12]=[E("取消",-1)])]),_:1}),V(c,{type:"primary",onClick:re,loading:j(F)},{default:I(()=>[...l[13]||(l[13]=[E("提交",-1)])]),_:1},8,["loading"])])]),default:I(()=>[V(p,{ref_key:"formRef",ref:Z,model:j(Y),rules:ee,"label-width":"100px"},{default:I(()=>[V(n,{gutter:20},{default:I(()=>[V(d,{span:12},{default:I(()=>[V(r,{label:"用户名",prop:"username"},{default:I(()=>[V(a,{modelValue:j(Y).username,"onUpdate:modelValue":l[0]||(l[0]=e=>j(Y).username=e),placeholder:"请输入用户名",disabled:"edit"===j(Q)},null,8,["modelValue","disabled"])]),_:1})]),_:1}),V(d,{span:12},{default:I(()=>[V(r,{label:"昵称",prop:"nickname"},{default:I(()=>[V(a,{modelValue:j(Y).nickname,"onUpdate:modelValue":l[1]||(l[1]=e=>j(Y).nickname=e),placeholder:"请输入昵称"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),V(n,{gutter:20},{default:I(()=>[V(d,{span:12},{default:I(()=>[V(r,{label:"邮箱",prop:"email"},{default:I(()=>[V(a,{modelValue:j(Y).email,"onUpdate:modelValue":l[2]||(l[2]=e=>j(Y).email=e),placeholder:"请输入邮箱"},null,8,["modelValue"])]),_:1})]),_:1}),V(d,{span:12},{default:I(()=>[V(r,{label:"手机号",prop:"phone"},{default:I(()=>[V(a,{modelValue:j(Y).phone,"onUpdate:modelValue":l[3]||(l[3]=e=>j(Y).phone=e),placeholder:"请输入手机号",maxlength:"11"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),V(n,{gutter:20},{default:I(()=>[V(d,{span:12},{default:I(()=>[V(r,{label:"性别",prop:"gender"},{default:I(()=>[V(u,{modelValue:j(Y).gender,"onUpdate:modelValue":l[4]||(l[4]=e=>j(Y).gender=e),placeholder:"请选择性别",style:{width:"100%"}},{default:I(()=>[V(i,{label:"未知",value:0}),V(i,{label:"男",value:1}),V(i,{label:"女",value:2})]),_:1},8,["modelValue"])]),_:1})]),_:1}),V(d,{span:12},{default:I(()=>[V(r,{label:"状态",prop:"status"},{default:I(()=>[V(u,{modelValue:j(Y).status,"onUpdate:modelValue":l[5]||(l[5]=e=>j(Y).status=e),placeholder:"请选择状态",style:{width:"100%"}},{default:I(()=>[V(i,{label:"启用",value:1}),V(i,{label:"禁用",value:0})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),V(n,{gutter:20},{default:I(()=>[V(d,{span:12},{default:I(()=>[V(r,{label:"部门",prop:"deptId"},{default:I(()=>[V(m,{modelValue:j(Y).deptId,"onUpdate:modelValue":l[6]||(l[6]=e=>j(Y).deptId=e),data:j(t),props:{label:"dept_name",value:"id",children:"children"},"default-expanded-keys":le(),"node-key":"id",placeholder:"请选择部门",clearable:"","check-strictly":"","render-after-expand":!1,style:{width:"100%"}},null,8,["modelValue","data","default-expanded-keys"])]),_:1})]),_:1}),V(d,{span:12},{default:I(()=>[V(r,{label:"岗位",prop:"postId"},{default:I(()=>[V(u,{modelValue:j(Y).postId,"onUpdate:modelValue":l[7]||(l[7]=e=>j(Y).postId=e),placeholder:"请选择岗位",clearable:"",style:{width:"100%"}},{default:I(()=>[(k(!0),w(x,null,q(j(o),e=>(k(),b(i,{key:e.id,value:e.id,label:e.post_name},null,8,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),V(r,{label:"角色",prop:"roleIds"},{default:I(()=>[V(u,{modelValue:j(Y).roleIds,"onUpdate:modelValue":l[8]||(l[8]=e=>j(Y).roleIds=e),multiple:"",placeholder:"请选择角色",style:{width:"100%"},"collapse-tags":"","collapse-tags-tooltip":""},{default:I(()=>[(k(!0),w(x,null,q(j(s),e=>(k(),b(i,{key:e.id,value:e.id,label:e.role_name},{default:I(()=>[O("span",K,P(e.role_name),1),O("span",W,P(e.description||"暂无描述"),1)]),_:2},1032,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1}),V(r,{label:"备注",prop:"remark"},{default:I(()=>[V(a,{modelValue:j(Y).remark,"onUpdate:modelValue":l[9]||(l[9]=e=>j(Y).remark=e),type:"textarea",rows:3,placeholder:"请输入备注"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])}}});export{Y as _,F as b,Z as d,Q as g};
