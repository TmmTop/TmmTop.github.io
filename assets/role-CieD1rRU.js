var e=Object.defineProperty,r=Object.defineProperties,o=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,n=(r,o,t)=>o in r?e(r,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[o]=t,i=(e,r)=>{for(var o in r||(r={}))l.call(r,o)&&n(e,o,r[o]);if(t)for(var o of t(r))s.call(r,o)&&n(e,o,r[o]);return e},d=(e,t)=>r(e,o(t)),c=(e,r,o)=>new Promise((t,l)=>{var s=e=>{try{i(o.next(e))}catch(r){l(r)}},n=e=>{try{i(o.throw(e))}catch(r){l(r)}},i=e=>e.done?t(e.value):Promise.resolve(e.value).then(s,n);i((o=o.apply(e,r)).next())});import{dS as a,dT as u}from"./index-Q3P-rwBo.js";function m(e){return c(this,null,function*(){const{roleName:r,roleCode:o,status:t,page:l=1,pageSize:s=10}=e||{};let n=(l-1)*s,c=a.from("sys_role").select("*",{count:"exact"});r&&(c=c.ilike("role_name",`%${r}%`),n=0),o&&(c=c.ilike("role_code",`%${o}%`),n=0),void 0!==t&&(c=c.eq("status",1===t),n=0);const{data:m,error:y,count:_}=yield c.order("sort",{ascending:!1}).range(n,n+s-1);if(y&&u(y.code,"获取角色列表失败"),m){return{list:m.map(e=>d(i({},e),{status:e.status?1:0})),total:_||0,page:l,pageSize:s}}return{list:[],total:0,page:l,pageSize:s}})}function y(e){return c(this,null,function*(){e||u("0","角色ID不能为空");const{data:r,error:o}=yield a.from("sys_role").select("*").eq("id",e).single();!o&&r||u(null==o?void 0:o.code,"角色不存在");const{data:t,error:l}=yield a.from("sys_role_menu").select("menu_id").eq("role_id",e);l&&u(l.code,"获取角色菜单权限失败");const s=null==t?void 0:t.map(e=>e.menu_id);return d(i({},r),{status:r.status?1:0,menuIds:s})})}function _(e){return c(this,null,function*(){const{roleName:r,roleKey:o,roleSort:t,status:l,description:s,menuIds:n}=e,{data:i,error:d}=yield a.from("sys_role").select("id").eq("role_name",r).single();("PGRST116"!==(null==d?void 0:d.code)||i)&&u(null==d?void 0:d.code,"角色名称已存在");const{data:c,error:m}=yield a.from("sys_role").select("id").eq("role_code",o).single();("PGRST116"!==(null==m?void 0:m.code)||c)&&u(null==m?void 0:m.code,"角色键已存在");const{data:y,error:_}=yield a.from("sys_role").insert({role_name:r,role_code:o,sort:t,status:l,description:s}).select("id").single();if(!_&&y||u(_.code,"创建角色失败"),n&&n.length>0){const e=n.map(e=>({role_id:null==y?void 0:y.id,menu_id:e})),{error:r}=yield a.from("sys_role_menu").insert(e);r&&u(r.code,"关联角色菜单权限失败")}return{message:"创建角色成功"}})}function f(e,r){return c(this,null,function*(){e||u("0","角色ID不能为空");const{roleName:o,roleKey:t,roleSort:l,status:s,description:n}=r,{data:i,error:d}=yield a.from("sys_role").select("id, role_name, role_code").eq("id",e).single();if(!d&&i||u(d.code,"角色不存在"),o&&o!==(null==i?void 0:i.role_name)){const{data:r,error:t}=yield a.from("sys_role").select("id").eq("role_name",o).neq("id",e).single();("PGRST116"!==(null==t?void 0:t.code)||r)&&u(null==t?void 0:t.code,"角色名称已存在")}if(t&&t!==(null==i?void 0:i.role_code)){const{data:r,error:o}=yield a.from("sys_role").select("id").eq("role_code",t).neq("id",e).single();("PGRST116"!==(null==o?void 0:o.code)||r)&&u(null==o?void 0:o.code,"角色键已存在")}const{error:c}=yield a.from("sys_role").update({role_name:o,role_code:t,sort:l,status:s,description:n}).eq("id",e);return c&&u(c.code,"更新角色失败"),{message:"更新角色成功"}})}function g(e){return c(this,null,function*(){e||u("0","角色ID不能为空");const{data:r,error:o}=yield a.from("sys_role").select("id").eq("id",e).single();!o&&r||u(o.code,"角色不存在");const{data:t,error:l}=yield a.from("sys_user_role").select("user_id").eq("role_id",e);l&&u(l.code,"检查角色用户失败"),t&&t.length>0&&u("0","该角色下存在用户，无法删除");const{error:s}=yield a.from("sys_role_menu").delete().eq("role_id",e);s&&u(s.code,"删除角色菜单权限关联失败");const{error:n}=yield a.from("sys_role").delete().eq("id",e);return n&&u(n.code,"删除角色失败"),{message:"删除角色成功"}})}function p(e){return c(this,null,function*(){e&&Array.isArray(e)&&0!==e.length||u("0","请选择要删除的角色");const{data:r,error:o}=yield a.from("sys_user_role").select("user_id").in("role_id",e);o&&u(o.code,"检查角色用户失败"),r&&r.length>0&&u("0","所选角色下存在用户，无法删除");const{error:t}=yield a.from("sys_role_menu").delete().in("role_id",e);t&&u(t.code,"删除角色菜单权限关联失败");const{error:l}=yield a.from("sys_role").delete().in("id",e);return l&&u(l.code,"批量删除角色失败"),{message:"批量删除角色成功"}})}function v(e,r){return c(this,null,function*(){e||u("0","角色ID不能为空");const{data:o,error:t}=yield a.from("sys_role").select("id").eq("id",e).single();!t&&o||u(t.code,"角色不存在");const{error:l}=yield a.from("sys_role_menu").delete().eq("role_id",e);if(l&&u(l.code,"删除旧角色菜单权限失败"),r&&r.length>0){const o=r.map(r=>({role_id:e,menu_id:r})),{error:t}=yield a.from("sys_role_menu").insert(o);t&&u(t.code,"添加新角色菜单权限失败")}return{message:"保存角色菜单权限成功"}})}export{y as a,p as b,_ as c,g as d,m as g,v as s,f as u};
